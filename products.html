<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Terminator Deals — Hot Deals</title>
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/css/styles.css">
<style>
  /* Базовые стили (оставил твой тёмный стиль) */
  body{background:#0e1015;color:#e9eef6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .title{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;margin-bottom:10px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#123}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 18px}
  .toolbar input,.toolbar select{background:#151a22;border:1px solid #232a36;color:#dfe7f3;border-radius:10px;padding:10px 12px}

  /* Сетка карточек. По умолчанию auto-fit с минимальной шириной 260px */
  .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}

  /* Принудительное число колонок (1/2/3/4) — с безопасным minmax,
     чтобы на совсем узких экранах колонок стало меньше, а не микрокарточки */
  body.cols-1 .grid{grid-template-columns:repeat(1,minmax(260px,1fr))}
  body.cols-2 .grid{grid-template-columns:repeat(2,minmax(260px,1fr))}
  body.cols-3 .grid{grid-template-columns:repeat(3,minmax(260px,1fr))}
  body.cols-4 .grid{grid-template-columns:repeat(4,minmax(260px,1fr))}

  .card{background:#131821;border:1px solid #202531;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px #0005}
  .thumb{width:100%;height:200px;object-fit:cover;display:block}
  .cat{position:absolute;left:10px;top:10px;background:#123;border:1px solid #245;color:#9fe;font-size:12px;padding:3px 8px;border-radius:999px}
  .ph{position:relative}
  .body{padding:12px}
  .t{font-weight:700;margin:2px 0 6px}
  .d{font-size:13px;opacity:.8;min-height:36px}
  .price{display:flex;align-items:center;gap:8px;margin-top:8px}
  .now{color:#22d47b;font-weight:800}
  .old{text-decoration:line-through;opacity:.6}
  .btns{display:flex;gap:8px;margin:12px 0 8px}
  .btn{flex:1;text-align:center;background:#0b5;border:0;color:#001;font-weight:700;padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn.sec{background:#18314f;color:#cfe}
  .btn.ghost{background:#161b25;color:#cfe;border:1px solid #2a3241}
  .like{display:inline-flex;align-items:center;gap:6px;font-size:13px;opacity:.8;cursor:pointer}
  .like.liked{color:#ffb703;opacity:1}
  .foot{display:flex;justify-content:space-between;align-items:center;padding:0 12px 12px}
  .hidden{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <img src="/assets/logo.png" alt="" width="28" height="28" style="border-radius:8px">
    <span>Terminator Deals — Hot Deals</span>
    <span class="badge">Live from Google Sheets → WhatsApp</span>
  </div>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Search by title, details, category">
    <select id="cat"><option value="">All categories</option></select>
    <!-- Новый селектор количества колонок -->
    <select id="cols">
      <option value="1">1 per row</option>
      <option value="2">2 per row</option>
      <option value="3">3 per row</option>
      <option value="4">4 per row</option>
    </select>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="hidden" style="opacity:.8;margin:18px 6px">Nothing found.</div>
</div>

<script>
/* === НАСТРОЙКИ === */
const SHEET_ID = '1KzTz3QsWVZeVuxtE7Jw0uAaqMBvvdQHT_Wuuv1zeWZk';
const PHONE = '13653784497';

/* === УТИЛИТЫ === */
const money = v => '$' + Number(v||0).toLocaleString('en-CA',{maximumFractionDigits:0});
const slug  = s => (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
const imgSrc = u => (!u)?'/assets/products/placeholder.webp':(/^https?:\/\//i.test(u)?u:(u.startsWith('/')?u:`/${u}`));
function likeKey(id){ return 'wt_like_'+id; }
function isLiked(id){ return localStorage.getItem(likeKey(id))==='1'; }
function toggleLike(id){
  const on = !isLiked(id);
  localStorage.setItem(likeKey(id), on?'1':'0');
  const el = document.querySelector(`[data-like="${id}"]`);
  if(el){ el.classList.toggle('liked', on); el.querySelector('span').textContent = on?'Liked':'Like'; }
}

/* === ЗАГРУЗКА ИЗ GOOGLE SHEETS (CSV) === */
async function loadItems(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
  const csv = await (await fetch(url,{cache:'no-store'})).text();
  return parseCSV(csv).map(r=>({
    title:r.title||'',price_now:+r.price_now||0,price_old:r.price_old||'',
    category:r.category||'',image:r.image||'',details:r.details||'',
    a_url:r.a_url||'',in_stock:(r.in_stock||'yes').toLowerCase().startsWith('y')?'yes':'no',
    id: slug(r.title)
  }));
}
function parseCSV(txt){
  const rows=[],r=[];let cell='',q=false;
  for(let i=0;i<txt.length;i++){
    const c=txt[i],n=txt[i+1];
    if(c==='\"'){ if(q&&n==='\"'){ cell+='\"'; i++; } else q=!q; }
    else if(c===','&&!q){ r.push(cell); cell=''; }
    else if((c==='\n'||c==='\r')&&!q){ if(cell!==''||r.length){ r.push(cell); rows.push(r.slice()); r.length=0; cell=''; } }
    else cell+=c;
  }
  if(cell!==''||r.length){ r.push(cell); rows.push(r); }
  const head=rows.shift().map(h=>h.trim());
  return rows.map(row=>{const o={};head.forEach((h,i)=>o[h]=row[i]??'');return o;});
}

/* === РЕНДЕР === */
let ITEMS=[],FILTER={q:'',cat:''};
async function init(){
  ITEMS = await loadItems();
  // категории только из in_stock
  const cats=[...new Set(ITEMS.filter(x=>x.in_stock==='yes').map(x=>x.category))].sort();
  const sel=document.getElementById('cat');
  cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o);});
  render();
}
function render(){
  const grid=document.getElementById('grid'),q=FILTER.q.toLowerCase(),cat=FILTER.cat;
  let list=ITEMS.filter(x=>x.in_stock==='yes');        // по умолчанию нет out-of-stock
  if(cat) list=list.filter(x=>x.category===cat);
  if(q) list=list.filter(x=>
    x.title.toLowerCase().includes(q) ||
    x.details.toLowerCase().includes(q) ||
    x.category.toLowerCase().includes(q)
  );

  grid.innerHTML=list.map(x=>{
    const wa=`https://wa.me/${PHONE}?text=${encodeURIComponent(
      `Hi! I'm interested in "${x.title}" (${money(x.price_now)}). Link: ${location.origin}/product.html?id=${x.id}`
    )}`;
    const compare=x.a_url?`<a class="btn sec" href="${x.a_url}" target="_blank" rel="noopener">Compare price</a>`:'';
    return `<article class="card">
      <div class="ph">
        <a href="/product.html?id=${x.id}"><img class="thumb" src="${imgSrc(x.image)}" alt=""></a>
        <span class="cat">${x.category||'Item'}</span>
      </div>
      <div class="body">
        <div class="t">${x.title}</div>
        <div class="d">${x.details.slice(0,100)}</div>
        <div class="price">
          <span class="now">${money(x.price_now)}</span>
          ${x.price_old?`<span class="old">${money(x.price_old)}</span>`:''}
        </div>
        <div class="btns">
          <a class="btn" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
          ${compare}
        </div>
      </div>
      <div class="foot">
        <div class="like ${isLiked(x.id)?'liked':''}" data-like="${x.id}" onclick="toggleLike('${x.id}')">★ <span>${isLiked(x.id)?'Liked':'Like'}</span></div>
      </div>
    </article>`;
  }).join('');

  document.getElementById('empty').classList.toggle('hidden', list.length>0);
}

/* === ФИЛЬТРЫ === */
document.getElementById('q').oninput = e => { FILTER.q=e.target.value; render(); };
document.getElementById('cat').onchange = e => { FILTER.cat=e.target.value; render(); };

/* === СЕЛЕКТОР КОЛОНОК (1/2/3/4) === */
const colsSelect = document.getElementById('cols');
function applyCols(n){
  document.body.classList.remove('cols-1','cols-2','cols-3','cols-4');
  document.body.classList.add('cols-'+n);
  localStorage.setItem('gridCols', String(n));
}
(function initCols(){
  // дефолт: 2 на телефоне, 3 на десктопе
  const isNarrow = window.matchMedia('(max-width: 600px)').matches;
  const def = isNarrow ? 2 : 3;
  const saved = Number(localStorage.getItem('gridCols')||def);
  applyCols(saved);
  colsSelect.value = String(saved);
  colsSelect.addEventListener('change', e => applyCols(Number(e.target.value)));
})();

/* === GO === */
init();
</script>
</body>
</html>
