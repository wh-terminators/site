<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terminator Deals — Hot Deals</title>
  <link rel="icon" href="favicon.ico">
  <style>
    :root{
      --bg: #0f1218; --card:#161b22; --text:#e9eef5; --muted:#9fb0c3; --brand:#16c172; --accent:#2d6cdf; --chip:#263040; --chipText:#9fb0c3; --shadow: 0 8px 28px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --card:#ffffff; --text:#0b1220; --muted:#4b5b70; --brand:#0aa46a; --accent:#1f5bd6; --chip:#e9eef6; --chipText:#42536a; --shadow: 0 8px 28px rgba(10,20,40,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:8px;background:#24d27e;color:#0c1a12;display:grid;place-items:center;font-weight:700}
    .title{font-weight:800;font-size:20px}
    .pill{font-size:12px;color:var(--chipText);background:var(--chip);border-radius:999px;padding:4px 10px;margin-left:8px;white-space:nowrap}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px}
    .input, .select, .btn{background:var(--card);border:1px solid rgba(120,140,160,.25);color:var(--text);border-radius:10px;padding:10px 12px}
    .input{flex:1;min-width:200px}
    .select{cursor:pointer}
    .btn{cursor:pointer}
    .btn.theme{padding:10px 12px}
    /* grid: 1 col phone, 2 col small tablets, 4 col desktop */
    .grid{display:grid;gap:18px}
    @media (max-width: 639px){ .grid{grid-template-columns: 1fr;} }
    @media (min-width: 640px) and (max-width: 1023px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (min-width: 1024px){ .grid{grid-template-columns: repeat(4, 1fr);} }

    .card{background:var(--card);border:1px solid rgba(120,140,160,.25);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio: 4/3; width:100%; object-fit:cover;background:#0b0f14}
    .badge{position:absolute;top:10px;left:10px;background:#1e293b;color:#cbd5e1;font-size:11px;padding:4px 8px;border-radius:999px}
    .body{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
    .h5{font-weight:700;margin:0}
    .meta{color:var(--muted);font-size:13px;min-height:38px}
    .price{display:flex;align-items:baseline;gap:10px}
    .now{color:#00d084;font-weight:800}
    .old{color:var(--muted);text-decoration:line-through}
    .line{display:flex;gap:10px}
    .btn.primary{background:var(--brand);border:none;color:#072116;font-weight:700}
    .btn.secondary{background:var(--chip);color:var(--chipText);border:none}
    .like{margin-top:4px;color:var(--muted);font-size:12px}
    .hidden{display:none !important}
    .empty{opacity:.7;border:1px dashed rgba(120,140,160,.35);border-radius:12px;padding:28px;text-align:center}
    .chipToggle{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">WT</div>
        <div class="title">Terminator Deals — Hot Deals</div>
        <span class="pill">Live from Google Sheets → WhatsApp</span>
      </div>
      <button id="theme" class="btn theme chipToggle" title="Toggle theme">🌙</button>
    </header>

    <div class="controls">
      <input id="q" class="input" placeholder="Search by title, details, category…" />
      <select id="cat" class="select"></select>
      <select id="stock" class="select">
        <option value="in">In stock only</option>
        <option value="all">All items</option>
      </select>
    </div>

    <section id="grid" class="grid"></section>
    <div id="empty" class="empty hidden">Nothing found.</div>
  </div>

  <script>
    /* ==== SETTINGS ==== */
    const SHEET_ID = "1KzTz3QsWVZeVuxtE7Jw0uAqMBvvdQHT_Wuuv1zeWZk"; // ваш ID
    const GID      = "0";                                   // лист
    const WHATSAPP = "13653784497";                         // номер WhatsApp
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

    /* ==== THEME TOGGLE ==== */
    const applyTheme = (t)=>{ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); document.getElementById('theme').textContent = t==='dark' ? '🌙' : '☀️'; };
    (()=>{
      const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
      applyTheme(saved);
      document.getElementById('theme').onclick = ()=> applyTheme( document.documentElement.getAttribute('data-theme')==='dark' ? 'light' : 'dark');
    })();

    /* ==== CSV → JSON ==== */
    async function fetchCSV(url){
      const res = await fetch(url, {cache:'no-store'});
      const txt = await res.text();
      const rows = txt.split(/\r?\n/).filter(r=>r.trim().length);
      const head = rows.shift().split(',').map(h=>h.trim().replace(/^"|"$/g,''));
      return rows.map(r=>{
        // split by commas but keep quoted commas
        const cols=[]; let cur='', q=false;
        for (let c of r){ if (c=='"'){ q=!q; cur+=c; } else if (c==',' && !q){ cols.push(cur); cur=''; } else { cur+=c; } }
        cols.push(cur);
        const obj={}; head.forEach((h,i)=>{ obj[h]= (cols[i]||'').replace(/^"|"$/g,''); }); return obj;
      });
    }

    /* ==== STATE ==== */
    let ITEMS=[], FILTER={q:'', cat:'all', stock:'in'};

    /* ==== RENDER ==== */
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    function money(n){ return '$' + Number(n).toLocaleString(); }
    function slug(s){ return String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    function cardTemplate(x){
      const id = slug(x.title) || crypto.randomUUID();
      const waMsg = encodeURIComponent(`Hi! I'm interested in ${x.title} for ${money(x.price_now)} (${x.category}).`);
      const wa = `https://wa.me/${WHATSAPP}?text=${waMsg}`;
      const img = x.image && /^https?:\/\//i.test(x.image) ? x.image : 'assets/placeholder.webp';
      const compare = x.amazon_url && /^https?:\/\//i.test(x.amazon_url) ? x.amazon_url : '';

      return `
      <article class="card">
        <a href="product.html?id=${encodeURIComponent(id)}" data-id="${id}">
          <div style="position:relative">
            <img class="thumb" loading="lazy" src="${img}" alt="${x.title}">
            <span class="badge">${x.category||'Item'}</span>
          </div>
        </a>
        <div class="body">
          <h3 class="h5">${x.title||''}</h3>
          <div class="meta">${x.details||''}</div>
          <div class="price">
            <div class="now">${money(x.price_now||0)}</div>
            ${x.price_old ? `<div class="old">${money(x.price_old)}</div>`:''}
          </div>
          <div class="line">
            <a class="btn primary" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
            ${compare ? `<a class="btn secondary" href="${compare}" target="_blank" rel="noopener">Compare price</a>`:''}
          </div>
          <div class="like">★ Like</div>
        </div>
      </article>`;
    }

    function render(){
      let list = ITEMS.slice();
      // stock filter
      if (FILTER.stock==='in'){ list = list.filter(x => (x.in_stock||'').toLowerCase().startsWith('y')); }
      // category
      if (FILTER.cat!=='all'){ list = list.filter(x => (x.category||'').toLowerCase()===FILTER.cat); }
      // query
      if (FILTER.q){ const q=FILTER.q.toLowerCase(); list = list.filter(x => (x.title+x.details+x.category).toLowerCase().includes(q)); }

      grid.innerHTML = list.map(cardTemplate).join('');
      empty.classList.toggle('hidden', list.length>0);
    }

    /* ==== INIT ==== */
    (async ()=>{
      const raw = await fetchCSV(SHEET_URL);
      // normalize keys (accept both amazon_url or fb_url columns gracefully)
      ITEMS = raw.map(row => ({
        id: slug(row.title),
        title: row.title || '',
        price_now: Number(row.price_now||0),
        price_old: row.price_old ? Number(row.price_old) : '',
        category: row.category || '',
        image: row.image || '',
        details: row.details || '',
        amazon_url: row.amazon_url || row.amz || '', // fallback if you name column differently
        in_stock: row.in_stock || ''
      }));

      // build categories
      const cat = document.getElementById('cat');
      const cats = Array.from(new Set(ITEMS.map(x=>x.category).filter(Boolean))).sort();
      cat.innerHTML = `<option value="all">All categories</option>` + cats.map(c=>`<option value="${c.toLowerCase()}">${c}</option>`).join('');
      cat.onchange = e => { FILTER.cat = e.target.value; render(); };

      // search
      document.getElementById('q').oninput = e => { FILTER.q = e.target.value.trim(); render(); };

      // stock
      const savedStock = localStorage.getItem('stock') || 'in';
      document.getElementById('stock').value = savedStock;
      FILTER.stock = savedStock;
      document.getElementById('stock').onchange = e => { FILTER.stock = e.target.value; localStorage.setItem('stock', FILTER.stock); render(); };

      render();
    })();
  </script>
</body>
</html>
