<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terminator Deals — Hot Deals</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    :root{
      --bg:#0b1320;--card:#101b2e;--text:#e7edf7;--muted:#a9b6c9;
      --accent:#14c36e;--accent-2:#2e7df7;--chip:#1a2a44;--danger:#ff5b5b;
      --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    [data-theme="light"]{
      --bg:#f4f7fb;--card:#ffffff;--text:#0e1726;--muted:#5b6b82;
      --accent:#0bbf66;--accent-2:#1b6cf7;--chip:#eef3fb;--danger:#e44242;
      --shadow:0 8px 24px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 60px;}
    header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .dot{width:34px;height:34px;border-radius:50%;display:inline-grid;place-items:center;background:var(--accent);font-weight:700;color:#07381f}
    h1{font-size:20px;margin:0 6px 0 0}
    .badge{font-size:12px;color:var(--muted);background:var(--chip);padding:3px 8px;border-radius:999px}

    /* панели */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0 20px}
    .search{flex:1;min-width:220px}
    .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3a57;background:var(--card);color:var(--text)}
    select,button.switch{padding:10px 12px;border-radius:10px;border:1px solid #2a3a57;background:var(--card);color:var(--text)}
    button.switch{cursor:pointer}

    /* сетка */
    #grid{display:grid;gap:18px}
    /* 1 на мобиле, 2 на планшете, 4 на десктопе */
    @media (min-width:640px){ #grid{grid-template-columns:repeat(2,1fr);} }
    @media (min-width:1024px){ #grid{grid-template-columns:repeat(4,1fr);} }

    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#0a1322 url('assets/placeholder.png') center/cover no-repeat}
    .body{padding:14px}
    .cat{display:inline-block;background:var(--chip);color:var(--muted);font-size:12px;padding:4px 8px;border-radius:999px;margin:6px 0}
    .title{font-weight:700;margin:4px 0 8px}
    .desc{color:var(--muted);font-size:14px;height:40px;overflow:hidden}
    .price{display:flex;align-items:baseline;gap:10px;margin:10px 0 12px}
    .now{color:var(--accent);font-weight:800}
    .old{color:var(--muted);text-decoration:line-through}
    .btns{display:flex;gap:10px;margin-top:auto;padding:0 14px 14px}
    .btn{flex:1;display:inline-flex;justify-content:center;align-items:center;gap:8px;border:none;border-radius:12px;padding:10px 12px;cursor:pointer;text-decoration:none;font-weight:700}
    .wapp{background:var(--accent);color:#05381f}
    .cmp{background:var(--accent-2);color:#fff}
    .hidden{display:none!important}

    .errorBox{background:#2c0e12;color:#ffb3b3;border:1px solid #ff6b6b;padding:10px;border-radius:10px;margin:10px 0}
    .empty{color:var(--muted);padding:30px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="dot">WT</div>
      <h1>Terminator Deals — Hot Deals</h1>
      <span class="badge">Live from Google Sheets → WhatsApp</span>
      <span id="status" class="badge"></span>
    </header>

    <div id="error" class="errorBox hidden"></div>

    <div class="toolbar">
      <div class="search"><input id="q" placeholder="Search by title, details, category…"></div>
      <select id="cat">
        <option value="">All categories</option>
      </select>
      <select id="stock">
        <option value="in">In stock only</option>
        <option value="all">All items</option>
      </select>
      <button class="switch" id="themeBtn">Toggle theme</button>
    </div>

    <section id="grid"></section>
    <div id="empty" class="empty hidden">Nothing found.</div>
  </div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = '1KzTz3QsWVZeVuxtE7Jw0uAaqMBvvdQHT_Wuuv1zeWZk';   // <- твой ID таблицы
// основной вариант (лучший): gviz CSV по gid=0
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=0`;
// запасной вариант (если вдруг 404): публикация в веб + export
const CSV_FALLBACK = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&id=${SHEET_ID}&gid=0`;

const WHATSAPP = '13653784497'; // твой номер без плюса
const STATUS = document.getElementById('status');
const ERRBOX = document.getElementById('error');

/* ======= HELPERS ======= */
const money = n => `$${Number(n||0).toLocaleString()}`;
const slug = s => String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

// простой CSV-парсер с поддержкой кавычек
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i], n=text[i+1];
    if(inQuotes){
      if(c === '"' && n === '"'){ field+='"'; i+=2; continue; }
      if(c === '"' && n !== '"'){ inQuotes=false; i++; continue; }
      field += c; i++; continue;
    }else{
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ','){ row.push(field); field=''; i++; continue; }
      if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; i++; continue; }
      if(c === '\r'){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  const header = rows.shift().map(h => h.trim());
  return rows.filter(r => r.length && r.some(v=>v!=='')).map(r => Object.fromEntries(header.map((h,idx)=>[h, r[idx]??''])));
}

function showError(msg){
  ERRBOX.textContent = msg;
  ERRBOX.classList.remove('hidden');
}

function ok(){ STATUS.textContent = '✓ loaded'; }

/* ======= RENDER ======= */
const FILTER = { q:'', cat:'', stock:'in' };
const els = {
  grid: document.getElementById('grid'),
  empty: document.getElementById('empty'),
  q: document.getElementById('q'),
  cat: document.getElementById('cat'),
  stock: document.getElementById('stock'),
  themeBtn: document.getElementById('themeBtn')
};

function cardTemplate(item){
  const id = slug(item.title);
  const img = (item.image||'').trim();
  const amz = (item.amazon_url||'').trim();
  const now = money(item.price_now);
  const old = item.price_old ? `<span class="old">${money(item.price_old)}</span>` : '';
  const cmpBtn = amz ? `<a class="btn cmp" href="${amz}" target="_blank" rel="noopener">Compare price</a>` : '';
  const msg = encodeURIComponent(`Hi! I'm interested in "${item.title}" for ${now}. Link: ${location.origin}/products.html#${id}`);

  return `
  <article class="card" id="${id}">
    <img class="thumb" src="${img}" alt="${item.title}" loading="lazy" onerror="this.src='assets/placeholder.png'">
    <div class="body">
      <span class="cat">${item.category||'—'}</span>
      <div class="title">${item.title||''}</div>
      <div class="desc">${item.details||''}</div>
      <div class="price"><span class="now">${now}</span>${old}</div>
    </div>
    <div class="btns">
      <a class="btn wapp" href="https://wa.me/${WHATSAPP}?text=${msg}" target="_blank" rel="noopener">WhatsApp</a>
      ${cmpBtn}
    </div>
  </article>`;
}

function render(list){
  const q = FILTER.q.toLowerCase();
  const cat = FILTER.cat;
  const wantInStock = FILTER.stock === 'in';

  const filtered = list.filter(it=>{
    if(wantInStock && String(it.in_stock||'').toLowerCase()!=='yes') return false;
    if(cat && it.category !== cat) return false;
    if(q){
      const hay = `${it.title} ${it.details} ${it.category}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  els.grid.innerHTML = filtered.map(cardTemplate).join('');
  els.empty.classList.toggle('hidden', filtered.length>0);
}

/* ======= LOAD ======= */
async function loadCSV(url){
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  return parseCSV(text);
}

async function init(){
  try{
    let rows;
    try{
      rows = await loadCSV(CSV_URL);
    }catch(e){
      // пробуем запасной URL (на случай 404)
      rows = await loadCSV(CSV_FALLBACK);
    }

    // ожидаемые заголовки:
    // title, price_now, price_old, category, image, details, amazon_url, in_stock
    // нормализуем ключи
    rows = rows.map(r=>{
      const obj = {};
      for(const k in r){ obj[k.trim().toLowerCase()] = r[k].trim(); }
      return obj;
    });

    // заполним категории
    const cats = [...new Set(rows.map(r=>r.category).filter(Boolean))].sort();
    els.cat.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option>${c}</option>`).join('');

    // первоначальные фильтры
    FILTER.stock = 'in';
    render(rows);

    // события
    els.q.oninput = e => { FILTER.q = e.target.value; render(rows); };
    els.cat.onchange = e => { FILTER.cat = e.target.value; render(rows); };
    els.stock.onchange = e => { FILTER.stock = e.target.value; render(rows); };

    // тема
    els.themeBtn.onclick = ()=>{
      const cur = document.documentElement.getAttribute('data-theme')||'dark';
      const next = cur==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    };
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

    ok();
  }catch(err){
    showError(`Failed to load Google Sheet. Details: ${err.message}`);
  }
}

init();
</script>
</body>
</html>
