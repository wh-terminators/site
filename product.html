<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Product • Terminator Deals</title>
<style>
:root{--bg:#0f1218;--card:#161b22;--text:#e9eef5;--muted:#9fb0c3;--brand:#16c172;--chip:#263040;--chipText:#9fb0c3;--shadow:0 8px 28px rgba(0,0,0,.35)}
[data-theme="light"]{--bg:#f6f8fb;--card:#fff;--text:#0b1220;--muted:#4b5b70;--brand:#0aa46a;--chip:#e9eef6;--chipText:#42536a;--shadow:0 8px 28px rgba(10,20,40,.12)}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Inter,Arial}
.wrap{max-width:980px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;gap:10px;margin-bottom:18px}
.logo{width:28px;height:28px;border-radius:8px;background:#24d27e;color:#0c1a12;display:grid;place-items:center;font-weight:800}
.btn{background:var(--card);border:1px solid rgba(120,140,160,.25);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
.btn.primary{background:var(--brand);border:none;color:#072116;font-weight:700}
.btn.secondary{background:var(--chip);color:var(--chipText);border:none}
.grid{display:grid;gap:24px}
@media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.img{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:14px;box-shadow:var(--shadow);background:#0b0f14}
.price{display:flex;align-items:baseline;gap:12px;font-size:20px}
.now{color:#00d084;font-weight:800}
.old{color:var(--muted);text-decoration:line-through}
.muted{color:var(--muted)}
.error{background:#331f1f;border:1px solid #cc6666;color:#ffd7d7;border-radius:10px;padding:10px 12px;margin:12px 0;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">WT</div>
    <a href="products.html" class="btn">← Back to catalog</a>
    <button id="theme" class="btn" style="margin-left:auto">Theme</button>
  </header>
  <div id="err" class="error" style="display:none"></div>
  <div id="content" class="grid"></div>
</div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1KzTz3QsWVZeVuxtE7Jw0uAqMBvvdQHT_Wuuv1zeWZk";
const GID = "0";
const SHEET_NAME = "Catalog";  // Имя листа как внизу таблицы
const WHATSAPP = "13653784497"; // Твой номер
const STATUS = document.getElementById('status');
const ERRBOX = document.getElementById('error');


const applyTheme=t=>{document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t)};
(()=>{applyTheme(localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));document.getElementById('theme').onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')})();

function slug(s){return String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')}
function money(n){return '$'+Number(n||0).toLocaleString();}
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(x=>x.trim().length);
  const head=lines.shift().match(/("([^"]|"")*"|[^,]+)/g).map(h=>h.replace(/^"|"$/g,''));
  return lines.map(row=>{
    const cols=row.match(/("([^"]|"")*"|[^,]+)/g)||[];
    const obj={}; head.forEach((h,i)=>{ obj[h]=(cols[i]||'').replace(/^"|"$/g,''); });
    return obj;
  });
}
async function loadSheet(){
  const urls=[
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`,
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`
  ];
  let last=null;
  for(const u of urls){
    try{const r=await fetch(u,{cache:'no-store'});if(!r.ok) throw new Error(`HTTP ${r.status}`);return parseCSV(await r.text());}
    catch(e){last=e;}
  }
  throw last||new Error('Load failed');
}

(async()=>{
  try{
    const id=new URLSearchParams(location.search).get('id');
    const rows=await loadSheet();
    const items=rows.map(r=>({id:slug(r.title),title:r.title||'',price_now:Number(r.price_now||0),price_old:r.price_old?Number(r.price_old):'',category:r.category||'',details:r.details||'',image:r.image||'',amazon_url:r.amazon_url||r.amz||'',in_stock:r.in_stock||''}));
    const x=items.find(i=>i.id===id)||items[0];
    if(!x){document.getElementById('err').style.display='block';document.getElementById('err').textContent='Product not found.';return;}
    const img=(x.image&&/^https?:\/\//i.test(x.image))?x.image:'assets/placeholder.webp';
    const cmp=(x.amazon_url&&/^https?:\/\//i.test(x.amazon_url))?x.amazon_url:'';
    const wa=`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(`Hi! I'm interested in ${x.title} for ${money(x.price_now)} (${x.category}).`)}`;
    document.title=`${x.title} — Terminator Deals`;
    document.getElementById('content').innerHTML=`
      <div><img class="img" src="${img}" alt="${x.title}"></div>
      <div>
        <h1 style="margin:0 0 6px">${x.title}</h1>
        <div class="muted" style="margin-bottom:12px">${x.category||''}</div>
        <div class="price" style="margin-bottom:14px">
          <span class="now">${money(x.price_now)}</span>
          ${x.price_old?`<span class="old">${money(x.price_old)}</span>`:''}
        </div>
        <p class="muted" style="margin-bottom:16px">${(x.details||'').replace(/\n/g,'<br>')}</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn primary" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
          ${cmp?`<a class="btn secondary" href="${cmp}" target="_blank" rel="noopener">Compare price</a>`:''}
        </div>
      </div>`;
  }catch(e){
    const b=document.getElementById('err'); b.style.display='block';
    b.textContent=`Failed to load product.\nCheck sharing and headers.\nDetails: ${e.message||String(e)}`;
    console.error(e);
  }
})();
</script>
</body>
</html>
