<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terminator Deals — Hot Deals</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1220;--card:#171a2b;--muted:#8ea0b5;--text:#eaf0ff;--brand:#22c55e;--brand-2:#2563eb;--chip:#1e293b;--error:#ef4444;
      --ring: rgba(37,99,235,.35);
    }
    [data-theme="light"]{
      --bg:#f6f7fb;--card:#ffffff;--muted:#5a6472;--text:#0f1420;--brand:#16a34a;--brand-2:#1d4ed8;--chip:#e8edf4;--ring: rgba(29,78,216,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:linear-gradient(180deg,#2a3348,transparent);border:1px solid #263148;color:#a7b6cb}
    .title{display:flex;align-items:center;gap:10px;font-weight:800}
    .title .dot{width:36px;height:36px;border-radius:50%;background:#22c55e22;display:grid;place-items:center;border:1px solid #233146}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .input, select{
      height:40px;border:1px solid #233146;background:var(--card);color:var(--text);
      border-radius:10px;padding:0 12px;outline:none;box-shadow:none;transition:.2s border,.2s box-shadow;width:100%;
    }
    .input:focus, select:focus{border-color:#2b4a95; box-shadow:0 0 0 4px var(--ring)}
    .controls > *{flex:1 1 220px}
    .toggle{display:flex;align-items:center;gap:8px}
    .toggle input{width:18px;height:18px}
    .rightControls{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}

    /* grid: 1 col mobile, 4 cols desktop */
    #grid{
      display:grid; gap:16px; margin-top:16px;
      grid-template-columns:1fr;
    }
    @media (min-width:1024px){
      #grid{ grid-template-columns:repeat(4, 1fr); }
    }

    .card{
      background:var(--card); border:1px solid #233146; border-radius:16px; overflow:hidden; position:relative;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{
      transform:translateY(-4px) scale(1.02);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      border-color:#2b4a95;
    }
    .thumb{position:relative;aspect-ratio:4/3;background:#0b0f1a;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition: transform .25s ease}
    .card:hover .thumb img{transform:scale(1.03)}
    .chip{position:absolute;top:8px;left:8px;background:var(--chip);color:#a9b6ca;border:1px solid #243145;border-radius:999px;font-size:12px;padding:3px 8px}
    .fav{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);border:1px solid #263148;border-radius:999px;padding:6px;cursor:pointer}
    .fav svg{width:18px;height:18px;fill:#ffffff60}
    .fav.active svg{fill:#ef4444}

    .body{padding:12px 12px 14px}
    .name{font-weight:700;line-height:1.25;margin:0 0 4px}
    .priceRow{display:flex;align-items:baseline;gap:8px;font-weight:700}
    .old{color:#8ea0b5;text-decoration:line-through;font-weight:600}
    .meta{display:flex;align-items:center;gap:8px;margin:8px 0;color:#9fb0c7;font-size:12px}
    .meta .dot{width:6px;height:6px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .details{color:#c7d5ea;font-size:13px;line-height:1.35;margin:8px 0 12px}
    .details.collapsed{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .more{background:transparent;border:none;color:#9ec5ff;cursor:pointer;padding:0;font-size:13px}

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      flex:1 1 130px; display:inline-flex;align-items:center;justify-content:center;gap:8px;
      height:40px;border-radius:12px;border:1px solid #233146;background:linear-gradient(180deg,#1b2334,transparent);
      color:var(--text); font-weight:700; text-decoration:none; transition:.18s transform,.18s box-shadow,.18s border;
    }
    .btn:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.25); border-color:#2b4a95}
    .btn.green{background:linear-gradient(180deg,#1f8a55,#10723f); border-color:#137845}
    .btn.blue{background:linear-gradient(180deg,#2356c9,#1f46a3); border-color:#244aa6}

    .errorBox{background:rgba(239,68,68,.1); color:#fecaca; border:1px solid rgba(239,68,68,.35); padding:12px;border-radius:12px}
    .hidden{display:none}

    .foot{color:#7890ac;font-size:12px;margin:14px 0}
    .ok{color:#7dd3fc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="title">
        <span class="dot">WT</span>
        <div>Terminator Deals — <span style="opacity:.85">Hot Deals</span></div>
      </div>
      <span id="status" class="badge">Live from Google Sheets → WhatsApp</span>
      <span id="loadmark" class="badge hidden ok">loaded</span>
    </div>

    <div class="controls">
      <input id="q" class="input" placeholder="Search by title, details, category…" />
      <select id="cat">
        <option value="*">All categories</option>
      </select>
      <select id="cond">
        <option value="*">All conditions</option>
        <option value="New">New</option>
        <option value="Like new">Like new</option>
        <option value="Used good">Used good</option>
      </select>
      <div class="toggle">
        <input id="stock" type="checkbox" checked>
        <label for="stock">In stock only</label>
      </div>
      <div class="rightControls">
        <select id="themeSel">
          <option value="dark">Theme: Dark</option>
          <option value="light">Theme: Light</option>
        </select>
      </div>
    </div>

    <div id="error" class="errorBox hidden"></div>

    <section id="grid"></section>
    <div id="empty" class="foot hidden">Nothing found.</div>
  </div>

<script>
/* ====== CONFIG (уже с твоими данными) ====== */
const SHEET_ID   = '1KzTz3QsWVZeVuxtE7Jw0uAaqMBvvdQHT_Wuuv1zeWZk';
const SHEET_NAME = 'Sheet1';
const WHATSAPP   = '+13653784497';
const SELF_URL   = 'https://terminatordeals.ca/products.html'; // для ссылки в WA
const STATUS = document.getElementById('status');
const ERRBOX = document.getElementById('error');
const LOADED = document.getElementById('loadmark');

/* ====== HELPERS ====== */
const money = n => `$${Number(n||0).toLocaleString()}`;
const slug  = s => String(s||'').toLowerCase().trim()
  .replace(/[^\p{L}\p{N}]+/ug,'-').replace(/^-+|-+$/g,'').slice(0,80);

function csvToObjects(text){
  // простой безопасный CSV-парсер (поддерживает запятые в кавычках)
  const rows = [];
  let i=0, cur='', row=[], inQ=false;
  while(i<text.length){
    const c = text[i];
    if(c === '"'){
      if(inQ && text[i+1] === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
    } else if(c === ',' && !inQ){ row.push(cur); cur=''; }
    else if((c === '\n' || c === '\r') && !inQ){
      if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
    } else cur += c;
    i++;
  }
  if(cur!=='' || row.length) row.push(cur), rows.push(row);

  const head = rows.shift().map(h=>h.trim());
  return rows.filter(r=>r.some(x=>x!=='')).map(r=>{
    const obj={};
    head.forEach((h,idx)=> obj[h] = (r[idx]||'').trim() );
    return obj;
  });
}

/* ====== STATE ====== */
let ITEMS = [];
const FILTER = {
  q: localStorage.getItem('f_q') || '',
  cat: localStorage.getItem('f_cat') || '*',
  cond: localStorage.getItem('f_cond') || '*',
  stock: (localStorage.getItem('f_stock') ?? '1') === '1',
};
const FAVS = new Set( JSON.parse(localStorage.getItem('favs')||'[]') );

/* ====== UI refs ====== */
const grid = document.getElementById('grid');
const qIn   = document.getElementById('q');
const catIn = document.getElementById('cat');
const condIn= document.getElementById('cond');
const stockIn = document.getElementById('stock');
const themeSel = document.getElementById('themeSel');

/* ====== THEME ====== */
(function initTheme(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  themeSel.value = saved;
  themeSel.addEventListener('change', e=>{
    const val = e.target.value;
    document.documentElement.setAttribute('data-theme', val);
    localStorage.setItem('theme', val);
    themeSel.options[0].textContent = `Theme: ${val[0].toUpperCase()+val.slice(1)}`;
  });
})();

/* ====== FETCH ====== */
async function loadSheet(){
  try{
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const rows = csvToObjects(text);

    // ожидаемые колонки: title, price_now, price_old, category, image, details, amazon_url, in_stock, condition
    ITEMS = rows.map(r=>{
      const id = slug(r.title || Math.random().toString(36).slice(2));
      return {
        id,
        title: r.title || 'Untitled',
        price_now: r.price_now || '',
        price_old: r.price_old || '',
        category: r.category || 'Other',
        image: r.image || '',
        details: r.details || '',
        amazon_url: r.amazon_url || '',
        in_stock: String(r.in_stock||'yes').toLowerCase().startsWith('y'),
        condition: r.condition || ''
      };
    });

    // заполнить категории
    const cats = Array.from(new Set(ITEMS.map(x=>x.category).filter(Boolean))).sort();
    catIn.innerHTML = `<option value="*">All categories</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    catIn.value = FILTER.cat;

    LOADED.classList.remove('hidden');
    render();
  }catch(err){
    ERRBOX.classList.remove('hidden');
    ERRBOX.textContent = `Failed to load Google Sheet. Details: ${err.message}`;
    console.error(err);
  }
}

/* ====== RENDER ====== */
function cardHTML(item){
  const fav = FAVS.has(item.id) ? 'active' : '';
  const price = `
    <div class="priceRow">
      <span>${money(item.price_now)}</span>
      ${item.price_old ? `<span class="old">${money(item.price_old)}</span>` : ''}
    </div>
  `;
  const stockDot = item.in_stock ? `<span class="dot"></span> In stock` : `<span class="dot" style="background:#ef4444"></span> Out of stock`;
  const cond = item.condition ? ` • ${item.condition}` : '';

  const wamsg = encodeURIComponent(
    `Hi! I'm interested in "${item.title}" for ${money(item.price_now)} (${item.category}${cond}).\n\nLink: ${SELF_URL}?item=${item.id}`
  );
  const wa = `https://wa.me/${WHATSAPP.replace(/\D/g,'')}?text=${wamsg}`;

  const detailsSafe = (item.details||'').replace(/\s+/g,' ').trim();

  return `
  <article class="card" data-id="${item.id}">
    <div class="thumb">
      <img src="${item.image}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/640x480?text=No+image'">
      <span class="chip">${item.category||'Item'}</span>
      <button class="fav ${fav}" title="Add to favorites" onclick="toggleFav('${item.id}', this)" aria-label="favorite">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s-6.716-4.117-9.428-7.07C.667 11.91.5 9.27 2.05 7.69 3.6 6.11 6.05 6 7.8 7.42 9.55 6 12 6.11 13.55 7.69c1.55 1.58 1.383 4.22-.522 6.24C18.716 16.883 12 21 12 21Z"/></svg>
      </button>
    </div>
    <div class="body">
      <h3 class="name">${item.title}</h3>
      ${price}
      <div class="meta">${stockDot}${cond ? `<span>${cond}</span>`:''}</div>
      <div class="details collapsed" id="d-${item.id}">${detailsSafe}</div>
      ${detailsSafe ? `<button class="more" onclick="toggleDetails('${item.id}', this)">Read more</button>`:''}
      <div class="btns">
        <a class="btn green" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
        ${ item.amazon_url ? `<a class="btn blue" href="${item.amazon_url}" target="_blank" rel="noopener nofollow">Compare price</a>` : '' }
      </div>
    </div>
  </article>`;
}

function toggleDetails(id, btn){
  const el = document.getElementById('d-'+id);
  if(!el) return;
  const collapsed = el.classList.toggle('collapsed');
  btn.textContent = collapsed ? 'Read more' : 'Show less';
}
window.toggleDetails = toggleDetails;

function toggleFav(id, btn){
  if(FAVS.has(id)){ FAVS.delete(id); btn.classList.remove('active'); }
  else{ FAVS.add(id); btn.classList.add('active'); }
  localStorage.setItem('favs', JSON.stringify([...FAVS]));
}
window.toggleFav = toggleFav;

function render(){
  const q = FILTER.q.toLowerCase();
  const list = ITEMS.filter(it=>{
    if(FILTER.stock && !it.in_stock) return false;
    if(FILTER.cat !== '*' && it.category !== FILTER.cat) return false;
    if(FILTER.cond !== '*' && (it.condition||'') !== FILTER.cond) return false;
    if(q){
      const hay = `${it.title} ${it.details} ${it.category}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  grid.innerHTML = list.map(cardHTML).join('');
  document.getElementById('empty').classList.toggle('hidden', list.length!==0);

  // статус
  STATUS.textContent = 'Live from Google Sheets → WhatsApp';
}

/* ====== FILTERS events + persistence ====== */
qIn.value = FILTER.q;
catIn.value = FILTER.cat;
condIn.value = FILTER.cond;
stockIn.checked = FILTER.stock;

qIn.oninput = e=>{ FILTER.q = e.target.value; localStorage.setItem('f_q',FILTER.q); render(); };
catIn.onchange = e=>{ FILTER.cat = e.target.value; localStorage.setItem('f_cat',FILTER.cat); render(); };
condIn.onchange = e=>{ FILTER.cond = e.target.value; localStorage.setItem('f_cond',FILTER.cond); render(); };
stockIn.onchange = e=>{ FILTER.stock = e.target.checked; localStorage.setItem('f_stock', FILTER.stock?'1':'0'); render(); };

/* ====== INIT ====== */
loadSheet();
</script>
</body>
</html>
