<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Terminator Deals — Hot Deals</title>
<link rel="icon" href="favicon.ico">
<style>
  :root { --cols: 4; --gap:20px; --card-bg:#10141b; --card-bd:rgba(255,255,255,.08); --muted:#9fb0c3; }

  body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#e9eef6; background:#0b1118;}
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px;}
  header{display:flex; align-items:center; gap:12px; margin-bottom:14px;}
  header .badge{background:#0ea5e9; color:#00131f; padding:4px 8px; border-radius:999px; font-weight:700;}
  header small{opacity:.7}

  .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 18px;}
  .toolbar input, .toolbar select{
    padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0f1621; color:#e9eef6; outline:none; min-height:42px;
  }
  .toolbar input{flex:1 1 260px; min-width:200px;}
  .toolbar select{flex:0 0 190px;}
  .right{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;}

  .grid{display:grid; grid-template-columns:repeat(var(--cols), minmax(0,1fr)); gap:var(--gap);}
  @media (max-width: 768px){ :root{ --cols:2; } }

  .card{
    background:linear-gradient(180deg,#0f1621 0%, #0c121b 100%);
    border:1px solid var(--card-bd); border-radius:16px; overflow:hidden; display:flex; flex-direction:column;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .thumb{aspect-ratio:4/3; background:#0a0f16; display:block; width:100%; object-fit:cover;}
  .cat{position:absolute; top:10px; left:10px; background:rgba(255,255,255,.08); padding:4px 8px; border-radius:999px; font-size:12px}
  .body{padding:12px 14px; display:flex; flex-direction:column; gap:6px}
  .title{font-weight:700; line-height:1.25}
  .meta{color:var(--muted); font-size:13px; line-height:1.35}
  .prices{display:flex; align-items:baseline; gap:10px; margin-top:4px}
  .now{color:#22c55e; font-weight:800}
  .old{color:#94a3b8; text-decoration:line-through}

  .btns{display:flex; gap:10px; margin-top:10px}
  .btn{
    flex:1 1 auto; text-align:center; text-decoration:none; font-weight:700; padding:10px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.12); background:#0f1621; color:#e9eef6;
  }
  .btn.whatsapp{background:#16a34a; color:#001a0b; border-color:#16a34a;}
  .btn.compare{background:#0ea5e9; color:#00131f; border-color:#0ea5e9;}
  .btn:disabled, .btn[aria-disabled="true"]{opacity:.45; pointer-events:none}

  .foot{display:flex; justify-content:space-between; padding:10px 14px 14px; color:#8aa0b8; font-size:12px; opacity:.8}
  .hidden{display:none !important}

  /* всплывашка детали */
  .details{display:none; margin-top:6px; color:#b6c3d3; font-size:14px}
  .more{cursor:pointer; color:#7dd3fc; font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="badge">WT</span>
      <h1 style="margin:0;font-size:22px">Terminator Deals — Hot Deals</h1>
      <small>Live from Google Sheets → WhatsApp</small>
    </header>

    <div class="toolbar">
      <input id="q" placeholder="Search by title, details, category…" />
      <select id="cat"></select>
      <select id="stock">
        <option value="in">In stock only</option>
        <option value="all">All items</option>
      </select>
      <div class="right">
        <select id="cols">
          <option value="auto" selected>Auto (2 mobile / 4 desktop)</option>
          <option value="1">1 per row</option>
          <option value="2">2 per row</option>
          <option value="3">3 per row</option>
          <option value="4">4 per row</option>
        </select>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <p id="empty" class="hidden" style="opacity:.7;margin-top:18px">Nothing found.</p>
  </div>

<script>
/** ===== CONFIG ===== **/
const SHEET_ID = "1KzTz3QsWVZeVuxtE7Jw0uAqMBvvdQHT_Wuuv1zeWZk";
const GID      = "0";
const WA_NUMBER = "13653784497"; // ✅ твой реальный WhatsApp
const SITE_ROOT = location.origin;

/** ===== HELPERS ===== **/
const qs = s => document.querySelector(s);
const money = n => n ? `$${Number(n).toLocaleString()}` : "";
const slug  = s => String(s||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");

/** ===== LOAD CSV FROM GOOGLE SHEETS ===== **/
async function loadItems(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
  const txt = await (await fetch(url, {cache:'no-store'})).text();

  const rows = [];
  let i=0, cell="", inQ=false, row=[];
  while(i<=txt.length){
    const c = txt[i++] || "\n";
    if(inQ){
      if(c === '"' && txt[i] === '"'){ cell+='"'; i++; }
      else if(c === '"'){ inQ=false; }
      else { cell+=c; }
    }else{
      if(c === '"'){ inQ=true; }
      else if(c === ","){ row.push(cell); cell=""; }
      else if(c === "\n" || c === "\r"){ if(cell!=="" || row.length){ row.push(cell); rows.push(row); row=[]; cell=""; } }
      else { cell+=c; }
    }
  }
  const header = rows.shift().map(h => h.trim().toLowerCase());
  const idx = k => header.indexOf(k);

  return rows.filter(r => r.length).map(r => ({
    title     : r[idx("title")]      || "",
    price_now : r[idx("price_now")]  || "",
    price_old : r[idx("price_old")]  || "",
    category  : r[idx("category")]   || "",
    image     : r[idx("image")]      || "",
    details   : r[idx("details")]    || "",
    url       : r[idx("url")]        || "",
    in_stock  : (r[idx("in_stock")]  || "").toLowerCase().startsWith("y")
  }));
}

/** ===== RENDER ===== **/
const STATE = { q:"", cat:"", stock:"in", cols:"auto", items:[], view:[] };

function buildCategories(items){
  const set = new Set(items.map(x => x.category).filter(Boolean));
  const cat = qs("#cat");
  const options = ['<option value="">All categories</option>', ...[...set].sort().map(c => `<option value="${c}">${c}</option>`)];
  cat.innerHTML = options.join("");
}

function filterItems(){
  const q = STATE.q.trim().toLowerCase();
  const inStockOnly = STATE.stock === "in";
  const cat = STATE.cat;

  STATE.view = STATE.items.filter(it => {
    if(inStockOnly && !it.in_stock) return false;
    if(cat && it.category !== cat) return false;
    if(q){
      const hay = `${it.title} ${it.details} ${it.category}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

function cardTemplate(it){
  const id = slug(it.title);
  const productLink = `${SITE_ROOT}/product.html?id=${encodeURIComponent(id)}`;
  const waMsg = encodeURIComponent(`Hi! I'm interested in "${it.title}" for ${money(it.price_now)}. Details: ${productLink}`);
  const wa = `https://wa.me/${WA_NUMBER}?text=${waMsg}`;

  const compareBtn = it.url ? `<a class="btn compare" href="${it.url}" target="_blank" rel="noopener">Compare price</a>` : `<a class="btn compare" aria-disabled="true">Compare price</a>`;

  return `
  <article class="card">
    <div style="position:relative">
      <img class="thumb" src="${it.image}" alt="${it.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
      ${it.category ? `<span class="cat">${it.category}</span>` : ``}
    </div>
    <div class="body">
      <div class="title">${it.title}</div>
      <div class="prices">
        <div class="now">${money(it.price_now)}</div>
        ${it.price_old ? `<div class="old">${money(it.price_old)}</div>` : ``}
      </div>
      ${it.details ? `<div class="meta">
          <span class="short">${it.details.slice(0, 95)}${it.details.length>95?'…':''}</span>
          ${it.details.length>95?`<span class="more" data-id="${id}">More</span>`:''}
          <div class="details" id="det-${id}">${it.details}</div>
        </div>` : ``}
      <div class="btns">
        <a class="btn whatsapp" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
        ${compareBtn}
      </div>
    </div>
    <div class="foot">
      <span>${it.in_stock ? "In stock" : "Out of stock"}</span>
      <a href="${productLink}" style="color:#7dd3fc" target="_blank" rel="noopener">Open page</a>
    </div>
  </article>`;
}

function render(){
  filterItems();
  const grid = qs("#grid");
  grid.innerHTML = STATE.view.map(cardTemplate).join("");

  grid.querySelectorAll(".more").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.getAttribute("data-id");
      const box = qs(`#det-${CSS.escape(id)}`);
      if(!box) return;
      const isShown = box.style.display === "block";
      box.style.display = isShown ? "none" : "block";
      el.textContent = isShown ? "More" : "Less";
    });
  });

  qs("#empty").classList.toggle("hidden", STATE.view.length);
}

/** ===== COLS CONTROL ===== **/
(function setupCols(){
  const select = qs("#cols");
  const KEY = "colsPref";
  function apply(mode){
    if(mode === "auto"){ document.documentElement.style.removeProperty("--cols"); }
    else {
      const n = Math.max(1, Math.min(6, parseInt(mode,10)||4));
      document.documentElement.style.setProperty("--cols", String(n));
    }
  }
  const saved = localStorage.getItem(KEY);
  if(saved){ select.value=saved; apply(saved); }
  select.addEventListener("change", e=>{
    const v = e.target.value;
    localStorage.setItem(KEY, v);
    apply(v);
  });
  window.addEventListener("resize", ()=>{ if(select.value==="auto"){ document.documentElement.style.removeProperty("--cols"); }});
})();

/** ===== FILTER UI ===== **/
qs("#q").addEventListener("input", e=>{ STATE.q = e.target.value; render(); });
qs("#cat").addEventListener("change", e=>{ STATE.cat = e.target.value; render(); });
qs("#stock").addEventListener("change", e=>{ STATE.stock = e.target.value; render(); });

/** ===== INIT ===== **/
(async function init(){
  try{
    STATE.items = await loadItems();
    buildCategories(STATE.items);
    STATE.stock = "in";
    render();
  }catch(err){
    console.error(err);
    qs("#empty").classList.remove("hidden");
    qs("#empty").textContent = "Failed to load items. Check sheet ID / permissions.";
  }
})();
</script>
</body>
</html>
