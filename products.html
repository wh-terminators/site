<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Terminator Deals — Hot Deals</title>
<link rel="icon" href="favicon.ico" />
<style>
  body{background:#0f141b;color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  .top{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
  h1{font-size:28px;margin:0}
  .pill{background:#14324a;border:1px solid #214a6b;color:#a6e3ff;padding:6px 10px;border-radius:999px;font-size:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
  .controls input,.controls select{background:#0b1117;border:1px solid #243447;border-radius:10px;color:#e9eef5;padding:10px 12px;font-size:14px;outline:none}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:780px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:520px){.grid{grid-template-columns:1fr}}
  .card{background:#121923;border:1px solid #1f2a37;border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{aspect-ratio:4/3;object-fit:cover;width:100%;background:#0b1117}
  .body{padding:14px}
  .title{font-size:16px;font-weight:700;margin:0 0 6px}
  .price{font-weight:800;color:#16d26e}
  .old{color:#90a4b8;text-decoration:line-through;margin-left:8px;font-weight:500}
  .meta{opacity:.75;font-size:12px;margin-top:6px}
  .row{display:flex;justify-content:space-between;gap:8px;margin-top:12px}
  .btn{display:inline-flex;justify-content:center;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid transparent;font-weight:700;text-decoration:none}
  .btn-wa{background:#24d366;color:#042410}
  .btn-fb{background:#0b1117;border-color:#223246;color:#9ec3ff}
  .badge{position:absolute;left:10px;top:10px;background:#0b1117cc;border:1px solid #223246;color:#bcd2e8;padding:4px 8px;border-radius:999px;font-size:12px}
  .card-top{position:relative}
  .empty{opacity:.7;margin:32px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Terminator Deals — Hot Deals</h1>
      <span class="pill">Live from Google Sheets → WhatsApp</span>
    </div>

    <div class="controls">
      <input id="search" type="search" placeholder="Search by title…" />
      <select id="cat"><option value="">All categories</option></select>
      <select id="stock">
        <option value="">All items</option>
        <option value="yes">In stock</option>
        <option value="no">Sold / hidden</option>
      </select>
    </div>

    <div id="grid" class="grid"></div>
    <p id="empty" class="empty" style="display:none">Nothing found.</p>
  </div>

<script>
  // === SETTINGS ===
  const SHEET_ID   = '1KzTz3QsWVZeVuxtE7Jw0uAaqMBvvdQHT_Wuuv1zeWZk'; // <-- твой ID
  const SHEET_NAME = 'Products';                               // <-- имя листа
  const WHATSAPP   = '13653784497';                            // <-- номер без плюса

  // gviz JSON endpoint:
  const GVIZ = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

  const grid  = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const catSel = document.getElementById('cat');
  const stockSel = document.getElementById('stock');
  const searchInput = document.getElementById('search');

  let ITEMS = [];

  function slug(s){return String(s||'').toLowerCase().trim();}

  function money(n){
    if(n==null||n==='') return '';
    const v = Number(n);
    return isFinite(v) ? `$${v.toFixed(v%1?2:0)}` : String(n);
  }

  function parseGviz(text){
    const json = text.replace(/^[\s\S]*setResponse\(/,'').replace(/\);?\s*$/,'');
    return JSON.parse(json);
  }

  function gvizToRows(gviz){
    const cols = gviz.table.cols.map(c=>c.label || c.id);
    return gviz.table.rows.map(r=>{
      const row = {};
      r.c.forEach((cell, i)=>{
        row[cols[i]] = cell ? cell.v : '';
      });
      return row;
    });
  }

  function buildWA(item){
    const msg = `Hi! I'm interested in "${item.title}" for ${money(item.price_now)} (category: ${item.category}).`;
    return `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}${item.fb_url?'%0A'+encodeURIComponent(item.fb_url):''}`;
  }

  function card(item){
    const fbBtn = item.fb_url ? `<a class="btn btn-fb" href="${item.fb_url}" target="_blank" rel="noopener">View on Facebook</a>` : '';
    let old = '';
if (item.price_old) {
  if (String(item.price_old).startsWith('http')) {
    old = `<a href="${item.price_old}" target="_blank" rel="noopener" class="btn btn-fb" style="margin-left:8px;">Compare on Amazon</a>`;
  } else {
    old = `<span class="old">${money(item.price_old)}</span>`;
  }
}

    const badge = item.category ? `<span class="badge">${item.category}</span>` : '';
    return `
      <article class="card">
        <div class="card-top">
          <img class="thumb" src="${item.image || ''}" alt="${item.title || ''}" loading="lazy" />
          ${badge}
        </div>
        <div class="body">
          <h3 class="title">${item.title || ''}</h3>
          <div class="price">${money(item.price_now)}${old}</div>
          <div class="meta">${item.details || ''}</div>
          <div class="row">
            <a class="btn btn-wa" href="${buildWA(item)}" target="_blank" rel="noopener">Message on WhatsApp</a>
            ${fbBtn}
          </div>
        </div>
      </article>
    `;
  }

  function render(){
    const q = slug(searchInput.value);
    const cat = catSel.value;
    const st  = stockSel.value;

    const filtered = ITEMS.filter(x=>{
      if (st && slug(x.in_stock) !== st) return false;
      if (cat && x.category !== cat) return false;
      if (q && !slug(x.title).includes(q)) return false;
      return true;
    });

    grid.innerHTML = filtered.map(card).join('');
    empty.style.display = filtered.length ? 'none' : '';
  }

  function fillCategories(){
    const set = new Set(ITEMS.map(i=>i.category).filter(Boolean));
    const now = catSel.value;
    catSel.innerHTML = `<option value="">All categories</option>` +
      [...set].sort().map(c=>`<option>${c}</option>`).join('');
    if ([...set].includes(now)) catSel.value = now;
  }

  async function load(){
    try{
      const res = await fetch(GVIZ, { cache:'no-store' });
      const text = await res.text();
      const g = parseGviz(text);
      const rows = gvizToRows(g);

      ITEMS = rows.map(r=>{
        const obj = {};
        for (const k in r) obj[k.trim().toLowerCase()] = r[k];
        return {
          title:     obj.title || '',
          price_now: obj.price_now || '',
          price_old: obj.price_old || '',
          category:  obj.category || '',
          image:     obj.image || '',
          details:   obj.details || '',
          fb_url:    obj.fb_url || '',
          in_stock:  (obj.in_stock || 'yes').toString().toLowerCase()
        };
      }).filter(x=>x.in_stock!=='no');

      fillCategories();
      render();
    }catch(e){
      console.error(e);
      empty.style.display='';
      empty.textContent = 'Failed to load products.';
    }
  }

  searchInput.addEventListener('input', render);
  catSel.addEventListener('change', render);
  stockSel.addEventListener('change', render);

  load();
</script>
</body>
</html>
