<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Terminator Deals — Hot Deals</title>

<!-- Minimal modern reset -->
<style>
  :root{
    --bg: #0b0f14; --card:#121823; --text:#e9eef5; --muted:#9fb0c3; --accent:#1dd75b; --badge:#1e2a3a; --chip:#1a2230; --border:#243044;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f8fb; --card:#ffffff; --text:#0b1220; --muted:#4b5b71; --accent:#13b04b; --badge:#e9eef5; --chip:#eef3fa; --border:#dbe4f0; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .badge{font-weight:600;padding:6px 10px;border-radius:999px;background:var(--badge);display:inline-block}
  .hint{font-size:12px;color:var(--muted);margin-left:auto}
  .toolbar{display:grid;grid-template-columns:1fr 170px 140px; gap:10px; margin:12px 0 18px}
  @media (max-width:680px){ .toolbar{grid-template-columns:1fr 1fr; } .cat{grid-column:2 / span 1} .stock{grid-column:1 / span 2}}
  .input,select{
    background:var(--card);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:10px 12px;outline:none;
  }
  .input::placeholder{color:var(--muted)}
  .switch{display:flex;align-items:center;gap:8px;justify-content:flex-end;color:var(--muted);font-size:14px}

  /* GRID: 1 на мобиле, 4 на ноутбуке */
  .grid{display:grid;gap:16px}
  .grid{grid-template-columns:repeat(1,minmax(0,1fr))}
  @media (min-width:700px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (min-width:1024px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr))}}

  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;
    box-shadow:0 6px 18px rgba(0,0,0,.08);
  }
  .thumb{position:relative;padding-top:62%;background:#0e141d}
  .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .chip{position:absolute;left:10px;top:10px;background:var(--chip);color:var(--muted);font-size:12px;border-radius:999px;padding:4px 8px}
  .body{padding:12px 14px 6px}
  .title{font-weight:700;margin:2px 0 6px}
  .desc{color:var(--muted);font-size:13px;height:38px;overflow:hidden}
  .prices{display:flex;align-items:center;gap:10px;margin:10px 0 8px}
  .now{font-weight:800}
  .old{color:var(--muted);text-decoration:line-through}
  .actions{display:flex;gap:10px;padding:10px 14px 14px}
  .btn{
    flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--border);text-align:center;font-weight:700;cursor:pointer;
    transition:.15s transform ease, .15s opacity ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .wa{background:var(--accent);color:#00190a;border:none}
  .cmp{background:transparent}
  .empty,.error{margin:30px 0;padding:16px;border-radius:10px}
  .empty{background:var(--card);color:var(--muted);border:1px dashed var(--border)}
  .error{background:#2b1214;color:#ffb4b4;border:1px solid #5e2026}
  small.muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">WT</div>
      <h1 style="margin:0;font-size:20px">Terminator Deals — Hot Deals</h1>
      <span class="hint">Live from Google Sheets → WhatsApp</span>
    </header>

    <div id="err" class="error" style="display:none"></div>

    <div class="toolbar">
      <input id="q" class="input" placeholder="Search by title, details, category…">
      <select id="cat" class="cat input"><option value="">All categories</option></select>
      <label class="stock switch">
        <input id="instock" type="checkbox" checked>
        <span>In stock only</span>
      </label>
    </div>

    <section id="grid" class="grid"></section>
    <div id="empty" class="empty" style="display:none">Nothing found.</div>
    <p style="margin-top:18px"><small class="muted">Tip: put image URLs (any public CDN or Facebook image URL), and Amazon comparison link into <code>amazon_url</code>.</small></p>
  </div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = '1KzTz3QsWVZeVuxte7Jw0uAaqMBbvdQHT_Wwuv1zeWZk'; // твоя таблица
const GID      = '0'; // gid листа (по умолчанию 0)
const WHATSAPP = '13653784497'; // номер для диалога WhatsApp (без +)
/* ==================== */

const GRID = document.getElementById('grid');
const ERR  = document.getElementById('err');
const EMPTY= document.getElementById('empty');
const Q    = document.getElementById('q');
const CAT  = document.getElementById('cat');
const IN   = document.getElementById('instock');

let ITEMS = [];
let FILTER = { q:'', cat:'', instock:true };

/* --- CSV fetch (надёжный) --- */
async function loadSheet() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&id=${SHEET_ID}&gid=${GID}`;
  const res = await fetch(url, { cache:'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  return parseCSV(text);
}

/* --- очень терпимый CSV парсер --- */
function parseCSV(text){
  // простой CSV (поддерживает запятые в кавычках)
  const rows = [];
  let row = [], cell = '', inQ = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (c === '"' ){ 
      if (inQ && n === '"'){ cell += '"'; i++; } else { inQ = !inQ; }
    } else if (c === ',' && !inQ){ row.push(cell); cell=''; }
      else if ((c === '\n' || c === '\r') && !inQ){
        if (c === '\r' && n === '\n') i++;
        row.push(cell); rows.push(row); row=[]; cell='';
      } else { cell += c; }
  }
  if (cell.length || row.length) { row.push(cell); rows.push(row); }

  const head = rows.shift().map(h => h.trim());
  return rows
    .filter(r => r.some(v => String(v).trim()!==''))
    .map(r => Object.fromEntries(head.map((h,i)=>[h, (r[i]??'').toString().trim()])));
}

/* --- утилиты --- */
const money = n => '$' + Number(n||0).toLocaleString();
const slug  = s => String(s||'').toLowerCase();

/* --- построение карточки --- */
function card(item){
  const waMsg = encodeURIComponent(`Hi! I'm interested in "${item.title}" for ${money(item.price_now)}.`);
  const wa = `https://wa.me/${WHATSAPP}?text=${waMsg}`;
  const cmp = item.amazon_url ? item.amazon_url : '#';

  return `
  <article class="card">
    <div class="thumb">
      <span class="chip">${item.category||'Item'}</span>
      <img loading="lazy" src="${item.image}" alt="${item.title}">
    </div>
    <div class="body">
      <div class="title">${item.title}</div>
      <div class="desc">${item.details||''}</div>
      <div class="prices">
        <div class="now">${money(item.price_now)}</div>
        ${item.price_old ? `<div class="old">${money(item.price_old)}</div>`:''}
      </div>
    </div>
    <div class="actions">
      <a class="btn wa"   href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
      <a class="btn cmp"  href="${cmp}" target="_blank" rel="noopener">Compare price</a>
    </div>
  </article>`;
}

/* --- рендер по фильтрам --- */
function render(){
  const q = slug(FILTER.q);
  const list = ITEMS.filter(it=>{
    if (FILTER.instock && slug(it.in_stock) !== 'yes') return false;
    if (FILTER.cat && it.category !== FILTER.cat) return false;
    if (q){
      const hay = `${it.title} ${it.details||''} ${it.category||''}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  GRID.innerHTML = list.map(card).join('');
  EMPTY.style.display = list.length ? 'none' : 'block';
}

/* --- заполнить селект категорий --- */
function fillCategories(){
  const set = new Set(ITEMS.filter(it=>it.category).map(it=>it.category));
  CAT.innerHTML = `<option value="">All categories</option>` + 
    Array.from(set).sort().map(c=>`<option value="${c}">${c}</option>`).join('');
}

/* --- инициализация --- */
async function init(){
  try{
    ERR.style.display='none'; ERR.textContent='';
    ITEMS = await loadSheet();

    // нормализуем поля
    ITEMS = ITEMS.map(x=>({
      title: x.title || '',
      price_now: x.price_now || '',
      price_old: x.price_old || '',
      category: x.category || '',
      image: x.image || '',
      details: x.details || '',
      amazon_url: x.amazon_url || '',
      in_stock: (x.in_stock || '').toLowerCase()
    }));

    fillCategories();
    render();
  }catch(e){
    ERR.style.display='block';
    ERR.textContent = `Failed to load Google Sheet. Details: ${e.message}`;
  }
}

/* --- события --- */
Q.oninput = e => { FILTER.q = e.target.value; render(); };
CAT.onchange = e => { FILTER.cat = e.target.value; render(); };
IN.onchange  = e => { FILTER.instock = e.target.checked; render(); };

init();
</script>
</body>
</html>
