<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Terminator Deals — Hot Deals</title>
<link rel="icon" href="favicon.ico">
<style>
:root{--bg:#0f1218;--card:#161b22;--text:#e9eef5;--muted:#9fb0c3;--brand:#16c172;--chip:#263040;--chipText:#9fb0c3;--shadow:0 8px 28px rgba(0,0,0,.35)}
[data-theme="light"]{--bg:#f6f8fb;--card:#fff;--text:#0b1220;--muted:#4b5b70;--brand:#0aa46a;--chip:#e9eef6;--chipText:#42536a;--shadow:0 8px 28px rgba(10,20,40,.12)}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Inter,Arial}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.logo{width:28px;height:28px;border-radius:8px;background:#24d27e;color:#0c1a12;display:grid;place-items:center;font-weight:800}
.title{font-weight:800}
.pill{font-size:12px;color:var(--chipText);background:var(--chip);border-radius:999px;padding:4px 10px;margin-left:8px}
.status{margin-left:auto;font-size:12px;padding:4px 10px;border-radius:999px;background:#3b4252;color:#d8dee9}
.btn{background:var(--card);border:1px solid rgba(120,140,160,.25);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 16px}
.input,.select{background:var(--card);border:1px solid rgba(120,140,160,.25);color:var(--text);border-radius:10px;padding:10px 12px}
.input{flex:1;min-width:200px}
.grid{display:grid;gap:18px}
@media (max-width:639px){.grid{grid-template-columns:1fr}}
@media (min-width:640px) and (max-width:1023px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (min-width:1024px){.grid{grid-template-columns:repeat(4,1fr)}}
.card{background:var(--card);border:1px solid rgba(120,140,160,.25);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
.thumb{aspect-ratio:4/3;width:100%;object-fit:cover;background:#0b0f14}
.badge{position:absolute;top:10px;left:10px;background:#1e293b;color:#cbd5e1;font-size:11px;padding:4px 8px;border-radius:999px}
.body{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
.h5{font-weight:700;margin:0}
.meta{color:var(--muted);font-size:13px;min-height:38px}
.price{display:flex;align-items:baseline;gap:10px}
.now{color:#00d084;font-weight:800}
.old{color:var(--muted);text-decoration:line-through}
.line{display:flex;gap:10px}
.btn.primary{background:var(--brand);border:none;color:#072116;font-weight:700}
.btn.secondary{background:var(--chip);color:var(--chipText);border:none}
.empty{opacity:.7;border:1px dashed rgba(120,140,160,.35);border-radius:12px;padding:28px;text-align:center}
.hidden{display:none!important}
.errorBox{background:#331f1f;border:1px solid #cc6666;color:#ffd7d7;border-radius:10px;padding:10px 12px;margin:12px 0;font-size:13px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">WT</div>
    <div class="title">Terminator Deals — Hot Deals</div>
    <span class="pill">Live from Google Sheets → WhatsApp</span>
    <span id="status" class="status">Loading…</span>
    <button id="theme" class="btn" title="Toggle theme">🌙</button>
  </header>

  <div class="controls">
    <input id="q" class="input" placeholder="Search by title, details, category…">
    <select id="cat" class="select"></select>
    <select id="stock" class="select">
      <option value="in">In stock only</option>
      <option value="all">All items</option>
    </select>
  </div>

  <div id="error" class="errorBox hidden"></div>
  <section id="grid" class="grid"></section>
  <div id="empty" class="empty hidden">Nothing found.</div>
</div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1KzTz3QsWVZeVuxtE7Jw0uAqMBvvdQHT_Wuuv1zeWZk"; // <<< ваш ID таблицы
const SHEET_NAME = "Sheet1"; // имя листа (точно как внизу в табах)
const GID = "0";             // или точный gid (из URL)
const WHATSAPP = "13653784497"; // ваш номер
const STATUS = document.getElementById('status');
const ERRBOX = document.getElementById('error');

/* ====== THEME ====== */
const applyTheme=t=>{document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);document.getElementById('theme').textContent=t==='dark'?'🌙':'☀️'};
(()=>{applyTheme(localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));document.getElementById('theme').onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')})();

/* ====== HELPERS ====== */
function money(n){return '$'+Number(n||0).toLocaleString();}
function slug(s){return String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}

/* CSV robust parser */
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(x=>x.trim().length);
  const head = lines.shift().match(/("([^"]|"")*"|[^,]+)/g).map(h=>h.replace(/^"|"$/g,''));
  return lines.map(row=>{
    const cols = row.match(/("([^"]|"")*"|[^,]+)/g)||[];
    const obj={}; head.forEach((h,i)=>{ obj[h]= (cols[i]||'').replace(/^"|"$/g,''); });
    return obj;
  });
}

/* Try both URLs */
async function loadSheet(){
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`,
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`
  ];
  let lastErr=null;
  for (const u of urls){
    try{
      STATUS.textContent='Loading…';
      const r = await fetch(u,{cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      const txt = await r.text();
      if(!txt.trim().length) throw new Error('Empty CSV');
      return parseCSV(txt);
    }catch(e){
      lastErr=e;
    }
  }
  throw lastErr||new Error('Unknown load error');
}

let ITEMS=[], FILTER={q:'',cat:'all',stock:'in'};

function cardTemplate(x){
  const id = slug(x.title)||crypto.randomUUID();
  const img = (x.image && /^https?:\/\//i.test(x.image)) ? x.image : 'assets/placeholder.webp';
  const compare = x.amazon_url && /^https?:\/\//i.test(x.amazon_url) ? x.amazon_url : '';
  const waMsg = encodeURIComponent(`Hi! I'm interested in ${x.title} for ${money(x.price_now)} (${x.category}).`);
  const wa = `https://wa.me/${WHATSAPP}?text=${waMsg}`;
  return `
  <article class="card">
    <a href="product.html?id=${encodeURIComponent(id)}">
      <div style="position:relative">
        <img class="thumb" loading="lazy" src="${img}" alt="${x.title}">
        <span class="badge">${x.category||'Item'}</span>
      </div>
    </a>
    <div class="body">
      <h3 class="h5">${x.title||''}</h3>
      <div class="meta">${x.details||''}</div>
      <div class="price">
        <span class="now">${money(x.price_now)}</span>
        ${x.price_old?`<span class="old">${money(x.price_old)}</span>`:''}
      </div>
      <div class="line">
        <a class="btn primary" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>
        ${compare?`<a class="btn secondary" href="${compare}" target="_blank" rel="noopener">Compare price</a>`:''}
      </div>
    </div>
  </article>`;
}

function render(){
  const grid=document.getElementById('grid');
  const empty=document.getElementById('empty');
  let list = ITEMS.slice();
  if(FILTER.stock==='in'){ list=list.filter(x=>(x.in_stock||'').toLowerCase().startsWith('y')); }
  if(FILTER.cat!=='all'){ list=list.filter(x=>(x.category||'').toLowerCase()===FILTER.cat); }
  if(FILTER.q){ const q=FILTER.q.toLowerCase(); list=list.filter(x=>(x.title+x.details+x.category).toLowerCase().includes(q)); }
  grid.innerHTML = list.map(cardTemplate).join('');
  empty.classList.toggle('hidden', list.length>0);
  STATUS.textContent = `${list.length} item(s)`;
}

(async()=>{
  try{
    const rows = await loadSheet();
    // normalize keys
    ITEMS = rows.map(r=>({
      id: slug(r.title),
      title: r.title||'',
      price_now: Number(r.price_now||0),
      price_old: r.price_old?Number(r.price_old):'',
      category: r.category||'',
      image: r.image||'',
      details: r.details||'',
      amazon_url: r.amazon_url||r.amz||'',
      in_stock: r.in_stock||''
    }));
    // build categories
    const catSel=document.getElementById('cat');
    const cats=[...new Set(ITEMS.map(x=>x.category).filter(Boolean))].sort();
    catSel.innerHTML='<option value="all">All categories</option>'+cats.map(c=>`<option value="${c.toLowerCase()}">${c}</option>`).join('');
    catSel.onchange=e=>{FILTER.cat=e.target.value;render();};
    document.getElementById('q').oninput=e=>{FILTER.q=e.target.value.trim();render();};
    const saved=localStorage.getItem('stock')||'in';
    document.getElementById('stock').value=saved; FILTER.stock=saved;
    document.getElementById('stock').onchange=e=>{FILTER.stock=e.target.value;localStorage.setItem('stock',FILTER.stock);render();};
    render();
  }catch(err){
    console.error('Load error:',err);
    STATUS.textContent='Error';
    ERRBOX.classList.remove('hidden');
    ERRBOX.textContent = `Failed to load Google Sheet.\n\nChecklist:\n• Share: Anyone with the link (Viewer)\n• Sheet name: "${SHEET_NAME}" or correct gid=${GID}\n• Header row: title,price_now,price_old,category,image,details,amazon_url,in_stock\n• Values: in_stock = yes/no\n\nDetails: ${err.message||String(err)}`;
  }
})();
</script>
</body>
</html>
