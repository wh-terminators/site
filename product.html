<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Deal</title>
<link rel="icon" href="/favicon.ico">
<style>
  body{background:#0e1015;color:#e9eef6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  .back{display:inline-flex;gap:8px;align-items:center;color:#9fe;text-decoration:none;margin-bottom:12px}
  .card{display:grid;grid-template-columns:1.2fr 1fr;gap:22px}
  @media(max-width:900px){.card{grid-template-columns:1fr}}
  #p-image{width:100%;height:440px;object-fit:cover;border-radius:16px;border:1px solid #202531}
  .title{font-weight:800;font-size:24px;margin:6px 0}
  .price{display:flex;gap:10px;align-items:center;margin:8px 0}
  .now{color:#22d47b;font-weight:900}
  .old{text-decoration:line-through;opacity:.6}
  .btns{display:flex;gap:10px;margin:14px 0}
  .btn{flex:1;text-align:center;background:#0b5;color:#001;font-weight:800;border-radius:12px;padding:12px 14px;text-decoration:none}
  .btn.sec{background:#18314f;color:#cfe}
  details{background:#121825;border:1px solid #222b3a;border-radius:12px;padding:12px}
  summary{cursor:pointer;font-weight:700;margin-bottom:6px}
</style>
</head>
<body>
<div class="wrap">
  <a class="back" href="/products.html">← Back to catalog</a>

  <div class="card">
    <img id="p-image" src="" alt="">
    <div>
      <div class="title" id="p-title"></div>
      <div class="price"><span class="now" id="p-now"></span><span class="old" id="p-old"></span></div>
      <div id="p-cat" style="opacity:.8;margin-bottom:6px"></div>

      <div class="btns">
        <a id="btn-wa" class="btn" target="_blank" rel="noopener">WhatsApp</a>
        <a id="btn-compare" class="btn sec hidden" target="_blank" rel="noopener">Compare price</a>
      </div>

      <details open>
        <summary>Details</summary>
        <div id="p-details"></div>
      </details>
    </div>
  </div>
</div>

<script>
const SHEET_ID = '1KzTz3QsWVZeVuxtE7Jw0uAaqMBvvdQHT_Wuuv1zeWZk';
const PHONE = '13653784497';
const money = v => '$' + Number(v||0).toLocaleString('en-CA',{maximumFractionDigits:0});
const imgSrc = u => (!u)?'/assets/products/placeholder.webp':(/^https?:\/\//i.test(u)?u:(u.startsWith('/')?u:`/${u}`));
const slug = s => (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

function qs(id){return document.getElementById(id)}
function getId(){const p=new URLSearchParams(location.search);return p.get('id')||''}

async function load(){
  const csv = await (await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`,{cache:'no-store'})).text();
  const items = parseCSV(csv).map(r=>({
    title:r.title||'', price_now:r.price_now, price_old:r.price_old, category:r.category||'',
    image:r.image||'', details:r.details||'', a_url:r.a_url||r.url||'', in_stock:(r.in_stock||'yes').toLowerCase().startsWith('y')?'yes':'no',
    id:slug(r.title)
  }));
  const id = getId();
  const item = items.find(x=>x.id===id) || items[0];
  if(!item){ location.href='/products.html'; return; }

  qs('p-image').src = imgSrc(item.image);
  qs('p-image').alt = item.title;
  qs('p-title').textContent = item.title;
  qs('p-cat').textContent = item.category||'';
  qs('p-now').textContent = money(item.price_now);
  qs('p-old').textContent = item.price_old?money(item.price_old):'';
  qs('p-details').textContent = item.details||'';

  const self = location.href; // ссылка обратно на эту страницу
  const msg = `Hi! I'm interested in "${item.title}" (${money(item.price_now)}). Link: ${self}`;
  qs('btn-wa').href = `https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`;

  if(item.a_url){
    const c = qs('btn-compare');
    c.href = item.a_url;
    c.classList.remove('hidden');
  }
}

function parseCSV(txt){
  const rows=[];let r=[],cell='',q=false;
  for(let i=0;i<txt.length;i++){
    const c=txt[i],n=txt[i+1];
    if(c==='\"'){ if(q&&n==='\"'){cell+='\"';i++;}else q=!q; }
    else if(c===','&&!q){ r.push(cell); cell=''; }
    else if((c==='\n'||c==='\r')&&!q){ if(cell!==''||r.length){ r.push(cell); rows.push(r); r=[]; cell=''; } }
    else cell+=c;
  }
  if(cell!==''||r.length){ r.push(cell); rows.push(r); }
  const head = rows.shift().map(h=>h.trim());
  return rows.filter(x=>x.length).map(row=>{const o={}; head.forEach((h,i)=>o[h]=row[i]??''); return o;});
}

load();
</script>
</body>
</html>
